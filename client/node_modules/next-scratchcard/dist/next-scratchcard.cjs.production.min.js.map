{"version":3,"file":"next-scratchcard.cjs.production.min.js","sources":["../src/index.tsx"],"sourcesContent":["import React, { useRef, useEffect, useCallback, useState } from 'react';\nimport { ScratchCardProps } from './types';\n\nexport const ScratchCard = ({\n  width = 300,\n  height = 150,\n  image = '',\n  finishPercent = 60,\n  onComplete = () => {},\n  brushSize = 30,\n  children,\n}: ScratchCardProps) => {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const isDrawingRef = useRef<boolean>(false);\n  const lastPositionRef = useRef<{\n    x: number;\n    y: number;\n  }>({ x: 0, y: 0 });\n  const autoRevealedRef = useRef<boolean>(false);\n  const [canvasLoaded, setCanvasLoaded] = useState<boolean>(false);\n\n  const getMousePosition = (canvas: any, event: any) => {\n    const rect = canvas.getBoundingClientRect();\n    return {\n      x: (event.clientX || event.touches[0].clientX) - rect.left,\n      y: (event.clientY || event.touches[0].clientY) - rect.top,\n    };\n  };\n\n  const startDrawing = useCallback((event: any) => {\n    isDrawingRef.current = true;\n    lastPositionRef.current = getMousePosition(canvasRef.current, event);\n  }, []);\n\n  const draw = useCallback(\n    (event: any) => {\n      if (\n        !isDrawingRef.current ||\n        autoRevealedRef.current ||\n        !canvasRef.current\n      )\n        return;\n      const ctx = canvasRef.current.getContext('2d');\n      const newPosition = getMousePosition(canvasRef.current, event);\n\n      if (ctx) {\n        ctx.globalCompositeOperation = 'destination-out';\n        ctx.lineWidth = brushSize;\n        ctx.lineCap = 'round';\n        ctx.beginPath();\n        ctx.moveTo(lastPositionRef.current.x, lastPositionRef.current.y);\n        ctx.lineTo(newPosition.x, newPosition.y);\n        ctx.stroke();\n\n        lastPositionRef.current = newPosition;\n\n        checkReveal(ctx);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [brushSize]\n  );\n\n  const checkReveal = useCallback(\n    (ctx: any) => {\n      const imageData = ctx.getImageData(0, 0, width, height);\n      const pixels = imageData.data;\n      let transparentPixels = 0;\n\n      for (let i = 0; i < pixels.length; i += 4) {\n        if (pixels[i + 3] === 0) transparentPixels++;\n      }\n\n      const totalPixels = width * height;\n      const currentPercentage = (transparentPixels / totalPixels) * 100;\n\n      if (currentPercentage >= finishPercent && !autoRevealedRef.current) {\n        autoRevealedRef.current = true;\n        ctx.clearRect(0, 0, width, height); // Clear the canvas here\n        onComplete(); // Call the onComplete callback\n      }\n    },\n    [finishPercent, width, height, onComplete]\n  );\n\n  const stopDrawing = useCallback(() => {\n    isDrawingRef.current = false;\n  }, []);\n\n  useEffect(() => {\n    if (canvasRef.current) {\n      const canvas = canvasRef.current;\n      canvas.width = width;\n      canvas.height = height;\n\n      const ctx = canvas.getContext('2d');\n\n      if (ctx) {\n        if (image) {\n          const backgroundImage = new Image();\n          backgroundImage.crossOrigin = 'anonymous';\n          backgroundImage.src = image;\n          backgroundImage.onload = () => {\n            ctx.drawImage(backgroundImage, 0, 0, width, height);\n            ctx.globalCompositeOperation = 'source-over';\n            setCanvasLoaded(true); // Set canvasLoaded to true when the image is loaded\n          };\n          backgroundImage.onerror = () => {\n            console.error('Failed to load the image with CORS policy');\n          };\n        } else {\n          ctx.fillStyle = '#000';\n          ctx.fillRect(0, 0, width, height);\n          setCanvasLoaded(true); // Set canvasLoaded to true when there is no image\n        }\n\n        canvas.addEventListener('mousedown', startDrawing);\n        canvas.addEventListener('mousemove', draw);\n        canvas.addEventListener('mouseup', stopDrawing);\n        canvas.addEventListener('mouseout', stopDrawing);\n\n        canvas.addEventListener('touchstart', startDrawing);\n        canvas.addEventListener('touchmove', draw);\n        canvas.addEventListener('touchend', stopDrawing);\n      }\n\n      return () => {\n        canvas.removeEventListener('mousedown', startDrawing);\n        canvas.removeEventListener('mousemove', draw);\n        canvas.removeEventListener('mouseup', stopDrawing);\n        canvas.removeEventListener('mouseout', stopDrawing);\n\n        canvas.removeEventListener('touchstart', startDrawing);\n        canvas.removeEventListener('touchmove', draw);\n        canvas.removeEventListener('touchend', stopDrawing);\n      };\n    }\n    return () => {};\n  }, [startDrawing, draw, stopDrawing, image, width, height]);\n\n  return (\n    <div style={{ position: 'relative', width, height }}>\n      <div style={{ position: 'absolute', zIndex: 999, width, height }}>\n        <canvas ref={canvasRef}></canvas>\n      </div>\n      {canvasLoaded && (\n        <div style={{ position: 'relative', width, height }}>{children}</div>\n      )}\n    </div>\n  );\n};\n"],"names":["_ref","width","_ref$width","_ref$height","height","_ref$image","image","_ref$finishPercent","finishPercent","_ref$onComplete","onComplete","_ref$brushSize","brushSize","children","canvasRef","useRef","isDrawingRef","lastPositionRef","x","y","autoRevealedRef","_useState","useState","canvasLoaded","setCanvasLoaded","getMousePosition","canvas","event","rect","getBoundingClientRect","clientX","touches","left","clientY","top","startDrawing","useCallback","current","draw","ctx","getContext","newPosition","globalCompositeOperation","lineWidth","lineCap","beginPath","moveTo","lineTo","stroke","checkReveal","pixels","getImageData","data","transparentPixels","i","length","clearRect","stopDrawing","useEffect","backgroundImage","Image","crossOrigin","src","onload","drawImage","onerror","console","error","fillStyle","fillRect","addEventListener","removeEventListener","React","style","position","zIndex","ref"],"mappings":"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"}