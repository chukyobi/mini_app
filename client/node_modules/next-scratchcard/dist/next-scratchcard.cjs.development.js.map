{"version":3,"file":"next-scratchcard.cjs.development.js","sources":["../src/index.tsx"],"sourcesContent":["import React, { useRef, useEffect, useCallback, useState } from 'react';\nimport { ScratchCardProps } from './types';\n\nexport const ScratchCard = ({\n  width = 300,\n  height = 150,\n  image = '',\n  finishPercent = 60,\n  onComplete = () => {},\n  brushSize = 30,\n  children,\n}: ScratchCardProps) => {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const isDrawingRef = useRef<boolean>(false);\n  const lastPositionRef = useRef<{\n    x: number;\n    y: number;\n  }>({ x: 0, y: 0 });\n  const autoRevealedRef = useRef<boolean>(false);\n  const [canvasLoaded, setCanvasLoaded] = useState<boolean>(false);\n\n  const getMousePosition = (canvas: any, event: any) => {\n    const rect = canvas.getBoundingClientRect();\n    return {\n      x: (event.clientX || event.touches[0].clientX) - rect.left,\n      y: (event.clientY || event.touches[0].clientY) - rect.top,\n    };\n  };\n\n  const startDrawing = useCallback((event: any) => {\n    isDrawingRef.current = true;\n    lastPositionRef.current = getMousePosition(canvasRef.current, event);\n  }, []);\n\n  const draw = useCallback(\n    (event: any) => {\n      if (\n        !isDrawingRef.current ||\n        autoRevealedRef.current ||\n        !canvasRef.current\n      )\n        return;\n      const ctx = canvasRef.current.getContext('2d');\n      const newPosition = getMousePosition(canvasRef.current, event);\n\n      if (ctx) {\n        ctx.globalCompositeOperation = 'destination-out';\n        ctx.lineWidth = brushSize;\n        ctx.lineCap = 'round';\n        ctx.beginPath();\n        ctx.moveTo(lastPositionRef.current.x, lastPositionRef.current.y);\n        ctx.lineTo(newPosition.x, newPosition.y);\n        ctx.stroke();\n\n        lastPositionRef.current = newPosition;\n\n        checkReveal(ctx);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [brushSize]\n  );\n\n  const checkReveal = useCallback(\n    (ctx: any) => {\n      const imageData = ctx.getImageData(0, 0, width, height);\n      const pixels = imageData.data;\n      let transparentPixels = 0;\n\n      for (let i = 0; i < pixels.length; i += 4) {\n        if (pixels[i + 3] === 0) transparentPixels++;\n      }\n\n      const totalPixels = width * height;\n      const currentPercentage = (transparentPixels / totalPixels) * 100;\n\n      if (currentPercentage >= finishPercent && !autoRevealedRef.current) {\n        autoRevealedRef.current = true;\n        ctx.clearRect(0, 0, width, height); // Clear the canvas here\n        onComplete(); // Call the onComplete callback\n      }\n    },\n    [finishPercent, width, height, onComplete]\n  );\n\n  const stopDrawing = useCallback(() => {\n    isDrawingRef.current = false;\n  }, []);\n\n  useEffect(() => {\n    if (canvasRef.current) {\n      const canvas = canvasRef.current;\n      canvas.width = width;\n      canvas.height = height;\n\n      const ctx = canvas.getContext('2d');\n\n      if (ctx) {\n        if (image) {\n          const backgroundImage = new Image();\n          backgroundImage.crossOrigin = 'anonymous';\n          backgroundImage.src = image;\n          backgroundImage.onload = () => {\n            ctx.drawImage(backgroundImage, 0, 0, width, height);\n            ctx.globalCompositeOperation = 'source-over';\n            setCanvasLoaded(true); // Set canvasLoaded to true when the image is loaded\n          };\n          backgroundImage.onerror = () => {\n            console.error('Failed to load the image with CORS policy');\n          };\n        } else {\n          ctx.fillStyle = '#000';\n          ctx.fillRect(0, 0, width, height);\n          setCanvasLoaded(true); // Set canvasLoaded to true when there is no image\n        }\n\n        canvas.addEventListener('mousedown', startDrawing);\n        canvas.addEventListener('mousemove', draw);\n        canvas.addEventListener('mouseup', stopDrawing);\n        canvas.addEventListener('mouseout', stopDrawing);\n\n        canvas.addEventListener('touchstart', startDrawing);\n        canvas.addEventListener('touchmove', draw);\n        canvas.addEventListener('touchend', stopDrawing);\n      }\n\n      return () => {\n        canvas.removeEventListener('mousedown', startDrawing);\n        canvas.removeEventListener('mousemove', draw);\n        canvas.removeEventListener('mouseup', stopDrawing);\n        canvas.removeEventListener('mouseout', stopDrawing);\n\n        canvas.removeEventListener('touchstart', startDrawing);\n        canvas.removeEventListener('touchmove', draw);\n        canvas.removeEventListener('touchend', stopDrawing);\n      };\n    }\n    return () => {};\n  }, [startDrawing, draw, stopDrawing, image, width, height]);\n\n  return (\n    <div style={{ position: 'relative', width, height }}>\n      <div style={{ position: 'absolute', zIndex: 999, width, height }}>\n        <canvas ref={canvasRef}></canvas>\n      </div>\n      {canvasLoaded && (\n        <div style={{ position: 'relative', width, height }}>{children}</div>\n      )}\n    </div>\n  );\n};\n"],"names":["ScratchCard","_ref","width","_ref$width","_ref$height","height","_ref$image","image","_ref$finishPercent","finishPercent","_ref$onComplete","onComplete","_ref$brushSize","brushSize","children","canvasRef","useRef","isDrawingRef","lastPositionRef","x","y","autoRevealedRef","_useState","useState","canvasLoaded","setCanvasLoaded","getMousePosition","canvas","event","rect","getBoundingClientRect","clientX","touches","left","clientY","top","startDrawing","useCallback","current","draw","ctx","getContext","newPosition","globalCompositeOperation","lineWidth","lineCap","beginPath","moveTo","lineTo","stroke","checkReveal","imageData","getImageData","pixels","data","transparentPixels","i","length","totalPixels","currentPercentage","clearRect","stopDrawing","useEffect","backgroundImage","Image","crossOrigin","src","onload","drawImage","onerror","console","error","fillStyle","fillRect","addEventListener","removeEventListener","React","style","position","zIndex","ref"],"mappings":"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"}